<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cep.project.service.impl.ProjectMapper">

	<resultMap id="project" type="com.cep.project.vo.ProjectVO">
		<result property="pjKey" column="PJ_KEY"/>
		<result property="acKey" column="AC_KEY"/>
		<result property="acDirectorKey" column="AC_DIRECTOR_KEY" />
		<result property="pjNm" column="PJ_NM"/>
		<result property="pjStartDt" column="PJ_START_DT"/>
		<result property="pjInspectDt" column="PJ_INSPECT_DT" />
		<result property="pjEndDt" column="PJ_END_DT"/>
		<result property="pjStatusCd" column="PJ_STATUS_CD"/>
		<result property="pjSaleEmpKey" column="PJ_SALE_EMP_KEY"/>
		<result property="pjSupportEmpKey" column="PJ_SUPPORT_EMP_KEY"/>
		<result property="remark" column="REMARK" />
		<result property="finishRemark" column="FINISH_REMARK" />
		<result property="deleteYn" column="DELETE_YN" />
		<result property="regEmpKey" column="REG_EMP_KEY" />
		<result property="spKey" column="SP_KEY" />
	</resultMap>

	<select id="selectProjectList" parameterType="projectVO" resultMap="project">

			SELECT
				PJ_KEY
				, (SELECT a.AC_NM FROM CMM_ACCOUNT_TB a WHERE a.AC_KEY = PJ_MAIN_TB.AC_KEY) AS acKey
				, PJ_NM
				, PJ_START_DT
				, PJ_END_DT
				, (SELECT c.CD_NM FROM CMM_CODE_MNG_TB c WHERE c.CD_KEY = PJ_MAIN_TB.PJ_STATUS_CD) AS pjStatusCd
				, (SELECT e.EMP_NM FROM CMM_EMPLOYEE_TB e WHERE e.EMP_KEY = PJ_MAIN_TB.PJ_SALE_EMP_KEY) AS pjSaleEmpKey
			FROM PJ_MAIN_TB
			WHERE 1=1
			<if test="searchFromDt != null and searchFromDt != ''">
					AND DATE_FORMAT(PJ_START_DT, '%Y-%m-%d') >= #{searchFromDt}
			</if>
			<if test="searchToDt != null and searchToDt != ''">
				<![CDATA[
					AND DATE_FORMAT(PJ_END_DT, '%Y-%m-%d') <= #{searchToDt}
				]]>
			</if> 
			<if test="searchKeyword != null and searchKeyword != ''">
					AND PJ_NM LIKE CONCAT('%' , #{searchKeyword}, '%')
			</if> 
	</select>

	<select id="selectProjectListTotCnt" parameterType="searchVO" resultType="int">

			SELECT COUNT(*)
			FROM PJ_MAIN_TB
			WHERE 1=1
			<!-- <if test="searchKeyword != null and searchKeyword != ''">
		        <choose>
		            <when test="searchCondition == 0">
						AND	USERNAME LIKE CONCAT('%' , #{searchKeyword}, '%')
					</when>
		            <when test="searchCondition == 1">
						AND	TITLE LIKE CONCAT('%' , #{searchKeyword}, '%')
					</when>
				</choose>
			</if> -->
	</select>

	<select id="selectProjectDetail" parameterType="String" resultType="egovMap">
		SELECT
			(SELECT CA.AC_NM FROM CMM_ACCOUNT_TB CA WHERE CA.AC_KEY = PJ_MAIN_TB.AC_KEY) AS AC_NM 
			, AC_KEY
			, AC_DIRECTOR_KEY
			, PJ_NM
			, PJ_START_DT
			, PJ_END_DT
			, PJ_SALE_EMP_KEY
			, PJ_SUPPORT_EMP_KEY
			, REMARK
			, PJ_INSPECT_DT
			, FINISH_REMARK
			, DELETE_YN
			, REG_DT
			, REG_EMP_KEY
			, REG_TM
			, SP_KEY
		FROM PJ_MAIN_TB
		WHERE PJ_KEY=#{pjKey}
			AND DELETE_YN = 'N'
	</select>
	
	<update id="updateStatusCd" parameterType="String">
		UPDATE PJ_MAIN_TB
		SET PJ_STATUS_CD = #{1}
		WHERE PJ_KEY = #{0}
	</update>
	
	<insert id="insertBasicInfo" parameterType="projectVO">
		INSERT INTO PJ_MAIN_TB (
			PJ_KEY
			, AC_KEY
			, AC_DIRECTOR_KEY
			, PJ_NM
			, PJ_START_DT
			, PJ_END_DT
			, PJ_SALE_EMP_KEY
			, PJ_SUPPORT_EMP_KEY
			, REMARK
			, DELETE_YN
			, REG_DT
			, REG_EMP_KEY
			, REG_TM
			, SP_KEY
			, PJ_STATUS_CD
		) VALUES (
			#{pjKey}
			, #{acKey}
			, #{acDirectorKey}
			, #{pjNm}
			, #{pjStartDt}
			, #{pjEndDt}
			, #{pjSaleEmpKey}
			, #{pjSupportEmpKey}
			, #{remark}
			, 'N'
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, #{regEmpKey}
			, DATE_FORMAT(NOW(),'%H%i%s')
			, #{spKey}
			, 'PJST1000'
		)
	</insert>
	
	<update id="updateBasicInfo" parameterType="projectVO">
		UPDATE PJ_MAIN_TB 
		SET	
			<if test="acKey != null and acKey != ''">
				AC_KEY = #{acKey},
			</if>
			<if test="acDirectorKey != null and acDirectorKey != ''">
				AC_DIRECTOR_KEY = #{acDirectorKey},
			</if>
			<if test="pjNm != null and pjNm != ''">
				PJ_NM = #{pjNm},
			</if>
			<if test="pjStartDt != null and pjStartDt != ''">
				PJ_START_DT = #{pjStartDt},
			</if>
			<if test="pjEndDt != null and pjEndDt != ''">
				PJ_END_DT = #{pjEndDt},
			</if>
			<if test="pjSaleEmpKey != null and pjSaleEmpKey != ''">
				PJ_SALE_EMP_KEY = #{pjSaleEmpKey},
			</if>
			<if test="pjSupportEmpKey != null and pjSupportEmpKey != ''">
				PJ_SUPPORT_EMP_KEY = #{pjSupportEmpKey},
			</if>
			<if test="remark != null and remark != ''">
				REMARK = #{remark},
			</if>
			<if test="pjInspectDt != null and pjInspectDt != ''">
				PJ_INSPECT_DT = #{pjInspectDt},
			</if>
			<if test="finishRemark != null and finishRemark != ''">
				FINISH_REMARK = #{finishRemark},
			</if>
			<if test="spKey != null and spKey != ''">
				SP_KEY = #{spKey},
			</if>
			<if test="pjInspectDt != null and pjInspectDt != ''">
				PJ_STATUS_CD = "PJST5000",
			</if>
			MOD_DT = DATE_FORMAT(NOW(),'%Y%m%d')
			, MOD_TM = DATE_FORMAT(NOW(),'%H%i%s')
			, MOD_EMP_KEY = #{modEmpKey}
		WHERE PJ_KEY = #{pjKey}
			AND DELETE_YN = 'N'
	</update>
	
	<update id="deleteProject" parameterType="projectVO">
		
	</update>
	
	<insert id="insertContractInfo" parameterType="projectContractSalesVO">
		INSERT INTO PJ_CONTRACT_TB (
			CT_KEY
			, PJ_KEY
			, CT_AMOUNT
			, TAX_YN
			, COLLECT_TURN
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
			, DELETE_YN
		) VALUES 
		<foreach collection="projectContractSalesVOList" item="item" separator=",">
			(
				#{item.ctKey}
				, #{pjKey}
				, #{item.ctAmount}
				, #{item.taxYn}
				, #{item.collectTurn}
				, DATE_FORMAT(NOW(),'%Y%m%d')
				, DATE_FORMAT(NOW(),'%H%i%s')
				, #{regEmpKey}
				, 'N'
			)
		</foreach>
	</insert>
	
	<select id="selectContractDetail" parameterType="String" resultType="egovMap">
		SELECT *
		FROM PJ_CONTRACT_TB 
		JOIN CMM_SALES_DETAIL_TB 
		ON PJ_CONTRACT_TB.PJ_KEY = CMM_SALES_DETAIL_TB.SALES_CT_FK_KEY 
		AND PJ_CONTRACT_TB.COLLECT_TURN = CMM_SALES_DETAIL_TB.SALES_TURN
		WHERE PJ_CONTRACT_TB.PJ_KEY=#{pjKey} ORDER BY COLLECT_TURN
	</select>
	
	<select id="selectBiddingDetail" parameterType="projectVO" resultType="com.cmm.mybatis.CamelCaseMap">
		SELECT 
			PJ_NM
			, M.AC_KEY
			, M.PJ_SALE_EMP_KEY
			, M.PJ_SUPPORT_EMP_KEY
			, M.PJ_START_DT
			, M.PJ_END_DT
			, B.BD_LIMIT_DT
			, B.BD_PROPOSAL_YN
			, B.BD_PROPOSAL_DUE_DT
			, B.BD_PROPOSAL_PRESENT_YN
			, B.BD_PROPOSAL_PRESENT_DT
		FROM PJ_MAIN_TB M
		LEFT OUTER JOIN PJ_BIDDING_TB B
		ON M.PJ_KEY = B.PJ_KEY
		WHERE M.PJ_KEY = #{pjKey}
		AND B.DELETE_YN = 'N'
	</select>
	
	<insert id="insertBiddingInfo" parameterType="guarantyBondVO">
		INSERT INTO CMM_GUARANTY_TB (
			GB_KEY
			, CT_KEY
			, SALES_KEY
			, GB_CLASS
			, GB_KIND_CD
			, GB_START_DT
			, GB_END_DT
			, GB_ISSUE_YN
			, GB_AMOUNT
			, SALES_KEY
		) VALUES (
			#{gbKey}
			, #{ctKey}
			, #{salesKey}
			, #{gbClass}
			, #{gbKindCd}
			, #{gbStartDt}
			, #{gbEndDt}
			, #{gbIssueYn}
			, #{gbAmount}
			, #{salesKey}
		)
	</insert>
	
	<insert id="insertOrderInfo" parameterType="orderVO">
		INSERT INTO CMM_ORDER_TB (
			ORDER_KEY
			, ORDER_CT_CLASS
			, ORDER_CT_FK_KEY
			, ORDER_DT
			, ORDER_AC_KEY
			, ORDER_AC_DIRECTOR_KEY
			, ORDER_PAY_TERMS
			, ORDER_AMOUNT
			, TAX_YN
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
			, DELETE_YN
		) VALUES (
			#{orderKey} 
			, #{orderCtClass}
			, #{orderCtFkKey}
			, #{orderDt}
			, #{orderAcKey}
			, #{orderAcDirectorKey}
			, #{orderPayTerms}
			, #{orderAmount}
			, #{taxYn}
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, DATE_FORMAT(NOW(),'%H%i%s')
			, #{regEmpKey}
			, 'N'
		)
	</insert>
	
	<insert id="insertOrderProductInfo" parameterType="java.util.HashMap">
		INSERT INTO CMM_ORDER_PRODUCT_TB (
			ORDER_KEY
			, ORDER_SEQ
			, ORDER_PM_FK_KEY
			, ORDER_QUANTITY
			, ORDER_UPRICE
			, ORDER_RECEIPT_DT
			, MT_RATE
			, FREE_MT_START_DT
			, FREE_MT_END_DT
			, DELETE_YN
		) VALUES 
		<foreach collection="orderProductVOList" item="item" separator=",">
		    (
			#{orderKey}
			, #{item.orderSeq} 
			, #{orderPmFkKey}
			, #{item.orderQuantity}
			, #{item.orderUprice}
			, #{item.orderReceiptDt}
			, #{mtRate}
			, #{freeMtStartDt}
			, #{freeMtEndDt}
			, 'N'
			)
		</foreach>
	</insert>
	
	<select id="selectOrderSelectBoxList" parameterType="String" resultType="egovMap">
		SELECT
			PO.ORDER_KEY
			, PO.ORDER_AC_KEY
			, CA.AC_NM
		FROM CMM_ORDER_TB PO, CMM_ACCOUNT_TB CA
		WHERE PO.ORDER_CT_FK_KEY=#{key}
			AND PO.DELETE_YN='N'
			AND PO.ORDER_AC_KEY = CA.AC_KEY
	</select>
	
	<select id="selectOrderDetail" parameterType="String" resultType="orderVO">
		SELECT
			CO.ORDER_KEY AS orderKey
			, CO.ORDER_CT_CLASS AS orderCtClass
			, CO.ORDER_CT_FK_KEY AS orderCtFkKey
			, CO.ORDER_DT AS orderDt
			, CO.ORDER_AC_KEY AS orderAcKey
			, (SELECT A.AC_NM FROM CMM_ACCOUNT_TB A WHERE A.AC_KEY = CO.ORDER_AC_KEY ) AS orderAcNm
			, CO.ORDER_AC_DIRECTOR_KEY AS orderAcDirectorKey
			, (SELECT AD.AC_DIRECTOR_NM FROM CMM_ACCOUNT_DIRECTOR_TB AD WHERE AD.AC_DIRECTOR_KEY = CO.ORDER_AC_DIRECTOR_KEY ) AS orderAcDirectorNm
			, (SELECT AD.AC_DIRECTOR_MB_NUM FROM CMM_ACCOUNT_DIRECTOR_TB AD WHERE AD.AC_DIRECTOR_KEY = CO.ORDER_AC_DIRECTOR_KEY) AS orderAcDirectorMbNum
			, CO.ORDER_PAY_TERMS AS orderPayTerms
			, CO.ORDER_AMOUNT AS orderAmount
			, CO.TAX_YN AS taxYn
		FROM CMM_ORDER_TB CO, CMM_ACCOUNT_TB CA
		WHERE CO.ORDER_KEY = #{orderKey}
			AND CO.DELETE_YN='N'
			AND CO.ORDER_AC_KEY = CA.AC_KEY
	</select>
	
	<select id="selectOrderProductList" parameterType="String" resultType="orderProductVO">
		SELECT
			OP.ORDER_KEY AS orderKey
			, OP.ORDER_SEQ AS orderSeq
			, OP.ORDER_PM_FK_KEY AS orderPmFkKey
			, OP.ORDER_QUANTITY AS orderQuantity
			, OP.ORDER_UPRICE AS orderUprice
			, OP.ORDER_RECEIPT_DT AS orderReceiptDt
			, OP.MT_RATE AS mtRate
			, OP.FREE_MT_START_DT AS freeMtStartDt
			, OP.FREE_MT_END_DT AS freeMtEndDt
			, PM.PM_NM_CD AS pmNmCd
		FROM CMM_ORDER_PRODUCT_TB OP, PM_PRODUCT_MNG_TB PM
		WHERE OP.ORDER_KEY = #{orderKey}
			AND OP.DELETE_YN='N'
			AND OP.ORDER_PM_FK_KEY = PM.PM_KEY
	</select>
	
	<select id="selectAcDirector" parameterType="Integer" resultType="egovMap">			
			SELECT AC_DIRECTOR_KEY
				, CONCAT(AC_DIRECTOR_NM, AC_DIRECTOR_POSITION_NM , ' / ' , AC_DIRECTOR_MB_NUM) AS AC_DIRECTOR_INFO
			FROM CMM_ACCOUNT_DIRECTOR_TB
			WHERE AC_DIRECTOR_KEY = #{acDirectorKey}
	</select>
	
	<select id="selectAcDirectorList" parameterType="String" resultType="egovMap">			
			SELECT AC_DIRECTOR_KEY
				, AC_DIRECTOR_NM
				, CONCAT(AC_DIRECTOR_POSITION_NM , ' / ' , AC_DIRECTOR_MB_NUM , ' / ' , AC_DIRECTOR_EMAIL) AS AC_DIRECTOR_INFO
			FROM CMM_ACCOUNT_DIRECTOR_TB
			WHERE AC_KEY = #{acKey}
			ORDER BY AC_DIRECTOR_NM		
	</select>
	
	<select id="selectFileList" parameterType="projectVO" resultType="com.cmm.mybatis.CamelCaseMap">
		SELECT
			FF.FILE_KEY
			, FF.FILE_ORG_NM
		FROM FM_FILE_MNG_TB FF
		JOIN FM_DOCTYPE_MNG_TB FD
		ON FD.DOC_TYPE_KEY = FF.DOC_TYPE_KEY
		WHERE FD.DOC_UP_TYPE_CD LIKE 'PJBD000%'
	</select>
	
	<insert id="insertBuildInfo" parameterType="projectBuildVO">
		INSERT INTO PJ_INSTALL_AND_BUILD_TB (
			PJ_KEY
			, INB_PLACE
			, INB_CLASS
			, INB_PM_KEY
			, INB_PM_SERIAL_NO
			, INB_DELIVERY_DT
			, INB_PM_VER
			, INB_SPEC_INFO
			, INB_CACHE_MEM
			, INB_PORT_INFO
			, INB_MNG_IP
			, INB_PM_TYPE
			, REMARK
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
			, DELETE_YN
		) VALUES (
			#{pjKey}
			, #{inbPlace}
			, #{inbClass}
			, #{inbPmKey}
			, #{inbPmSerialNo}
			, #{inbDeliveryDt}
			, #{inbPmVer}
			, #{inbSpecInfo}
			, #{inbCacheMem}
			, #{inbPortInfo}
			, #{inbMngIp}
			, #{inbPmType}
			, #{remark}
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, DATE_FORMAT(NOW(),'%H%i%s')
			, #{regEmpKey}
			, 'N'
		)
	</insert>
	
	<select id="selectBuildDetail" parameterType="String" resultType="egovMap">
		SELECT
			INB.PJ_KEY
			, INB.INB_PLACE
			, INB.INB_CLASS
			, INB.INB_PM_KEY
			, PM.PM_NM_CD AS inbPmNm
			, INB.INB_PM_SERIAL_NO
			, INB.INB_DELIVERY_DT
			, INB.INB_PM_VER
			, INB.INB_SPEC_INFO
			, INB.INB_CACHE_MEM
			, INB.INB_PORT_INFO
			, INB.INB_MNG_IP
			, INB.INB_PM_TYPE
			, INB.REMARK
		FROM PJ_INSTALL_AND_BUILD_TB INB, PM_PRODUCT_MNG_TB PM
		WHERE PJ_KEY=#{pjKey}
			AND INB.INB_PM_KEY = PM.PM_KEY
			AND DELETE_YN = 'N'
	</select>
	
	<insert id="insertWorkInfo" parameterType="projectWorkVO">
		INSERT INTO PJ_WORK_TB (
			PJ_KEY
			, PJ_WORK_CLASS_CD
			, PJ_WORK_DT
			, PJ_WORK_TM
			, PJ_WORK_TAKE_TM
			, PJ_WORK_NM
			, PJ_WORK_CONT
			, PJ_WORK_RESULT
			, REMARK
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
			, DELETE_YN
		) VALUES (
			#{pjKey}
			, #{pjWorkClassCd}
			, #{pjWorkDt}
			, #{pjWorkTm}
			, #{pjWorkTakeTm}
			, #{pjWorkNm}
			, #{pjWorkCont}
			, #{pjWorkResult}
			, #{remark}
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, DATE_FORMAT(NOW(),'%H%i%s')
			, #{regEmpKey}
			, 'N'
		)
	</insert>
	
	<select id="selectWorkDetail" parameterType="String" resultType="egovMap">
		SELECT
			PJ_KEY
			, PJ_WORK_CLASS_CD
			, PJ_WORK_DT
			, PJ_WORK_TM
			, PJ_WORK_TAKE_TM
			, PJ_WORK_NM
			, PJ_WORK_CONT
			, PJ_WORK_RESULT
			, REMARK
		FROM PJ_WORK_TB
		WHERE PJ_KEY=#{pjKey}
			AND DELETE_YN = 'N'
	</select>
</mapper>