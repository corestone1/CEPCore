<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cep.project.service.impl.ProjectMapper">

	<resultMap id="project" type="com.cep.project.vo.ProjectVO">
		<result property="pjKey" column="PJ_KEY"/>
		<result property="acKey" column="AC_KEY"/>
		<result property="acDirectorKey" column="AC_DIRECTOR_KEY" />
		<result property="pjNm" column="PJ_NM"/>
		<result property="pjStartDt" column="PJ_START_DT"/>
		<result property="pjInspectDt" column="PJ_INSPECT_DT" />
		<result property="pjEndDt" column="PJ_END_DT"/>
		<result property="pjStatusCd" column="PJ_STATUS_CD"/>
		<result property="pjSaleEmpKey" column="PJ_SALE_EMP_KEY"/>
		<result property="pjSupportEmpKey" column="PJ_SUPPORT_EMP_KEY"/>
		<result property="remark" column="REMARK" />
		<result property="deleteYn" column="DELETE_YN" />
		<result property="regEmpKey" column="REG_EMP_KEY" />
		<result property="spKey" column="SP_KEY" />
	</resultMap>

	<select id="selectProjectList" parameterType="projectVO" resultMap="project">

			SELECT
				PJ_KEY
				, (SELECT a.AC_NM FROM CMM_ACCOUNT_TB a WHERE a.AC_KEY = PJ_MAIN_TB.AC_KEY) AS acKey
				, PJ_NM
				, PJ_START_DT
				, PJ_END_DT
				, PJ_STATUS_CD
				, (SELECT e.EMP_NM FROM CMM_EMPLOYEE_TB e WHERE e.EMP_KEY = PJ_MAIN_TB.PJ_SALE_EMP_KEY) AS pjSaleEmpKey
			FROM PJ_MAIN_TB
			WHERE 1=1
			<if test="searchFromDt != null and searchFromDt != ''">
					AND DATE_FORMAT(PJ_START_DT, '%Y-%m-%d') >= #{searchFromDt}
			</if>
			<if test="searchToDt != null and searchToDt != ''">
				<![CDATA[
					AND DATE_FORMAT(PJ_END_DT, '%Y-%m-%d') <= #{searchToDt}
				]]>
			</if> 
			<if test="searchKeyword != null and searchKeyword != ''">
					AND PJ_NM LIKE CONCAT('%' , #{searchKeyword}, '%')
			</if> 
	</select>

	<select id="selectProjectListTotCnt" parameterType="searchVO" resultType="int">

			SELECT COUNT(*)
			FROM PJ_MAIN_TB
			WHERE 1=1
			<!-- <if test="searchKeyword != null and searchKeyword != ''">
		        <choose>
		            <when test="searchCondition == 0">
						AND	USERNAME LIKE CONCAT('%' , #{searchKeyword}, '%')
					</when>
		            <when test="searchCondition == 1">
						AND	TITLE LIKE CONCAT('%' , #{searchKeyword}, '%')
					</when>
				</choose>
			</if> -->
	</select>

	<select id="selectProjectDetail" parameterType="String" resultType="egovMap">
		
		SELECT
			AC_KEY
			, AC_DIRECTOR_KEY
			, PJ_NM
			, PJ_START_DT
			, PJ_END_DT
			, PJ_SALE_EMP_KEY
			, PJ_SUPPORT_EMP_KEY
			, REMARK
			, DELETE_YN
			, REG_DT
			, REG_EMP_KEY
			, REG_TM
			, SP_KEY
		FROM PJ_MAIN_TB
		WHERE PJ_KEY=#{pjKey}
		
	</select>
	
	<insert id="insertBasicInfo" parameterType="projectVO">
		INSERT INTO PJ_MAIN_TB (
			PJ_KEY
			, AC_KEY
			, AC_DIRECTOR_KEY
			, PJ_NM
			, PJ_START_DT
			, PJ_END_DT
			, PJ_SALE_EMP_KEY
			, PJ_SUPPORT_EMP_KEY
			, REMARK
			, DELETE_YN
			, REG_DT
			, REG_EMP_KEY
			, REG_TM
			, SP_KEY
		) VALUES (
			#{pjKey}
			, #{acKey}
			, #{acDirectorKey}
			, #{pjNm}
			, #{pjStartDt}
			, #{pjEndDt}
			, #{pjSaleEmpKey}
			, #{pjSupportEmpKey}
			, #{remark}
			, 'N'
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, #{regEmpKey}
			, DATE_FORMAT(NOW(),'%k%i%s')
			, #{spKey}
		)
	</insert>
	
	<insert id="insertContractInfo" parameterType="projectContractVO">
		INSERT INTO PJ_CONTRACT_TB (
			CT_KEY
			, PJ_KEY
			, CT_AMOUNT
			, TAX_YN
			, MT_CT_DT
			, CT_TURN_NO
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
			, DELETE_YN
		) VALUES (
			#{ctKey}
			, #{pjKey}
			, #{ctAmount}
			, #{taxYn}
			, #{mtCtDt}
			, #{ctTurnNo}
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, DATE_FORMAT(NOW(),'%k%i%s')
			, #{regEmpKey}
			, 'N'
		)
	</insert>
	
	<select id="selectBiddingDetail" parameterType="projectVO" resultType="com.cmm.mybatis.CamelCaseMap">
		SELECT 
			PJ_NM
			, M.AC_KEY
			, M.PJ_SALE_EMP_KEY
			, M.PJ_SUPPORT_EMP_KEY
			, M.PJ_START_DT
			, M.PJ_END_DT
			, B.BD_LIMIT_DT
			, B.BD_PROPOSAL_YN
			, B.BD_PROPOSAL_DUE_DT
			, B.BD_PROPOSAL_PRESENT_YN
			, B.BD_PROPOSAL_PRESENT_DT
		FROM PJ_MAIN_TB M
		LEFT OUTER JOIN PJ_BIDDING_TB B
		ON M.PJ_KEY = B.PJ_KEY
		WHERE M.PJ_KEY = #{pjKey}
		AND B.DELETE_YN = 'N'
	</select>
	
	<select id="selectFileList" parameterType="projectVO" resultType="com.cmm.mybatis.CamelCaseMap">
		SELECT
			FF.FILE_KEY
			, FF.FILE_ORG_NM
		FROM FM_FILE_MNG_TB FF
		JOIN FM_DOCTYPE_MNG_TB FD
		ON FD.DOC_TYPE_KEY = FF.DOC_TYPE_KEY
		WHERE FD.DOC_UP_TYPE_CD LIKE 'PJBD000%'
	</select>
</mapper>