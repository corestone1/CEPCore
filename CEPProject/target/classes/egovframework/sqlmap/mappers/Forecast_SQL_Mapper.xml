<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cep.forecast.service.impl.ForecastMapper">

<!--Forecast 관련 sql 관리하는 Mapper.xml  -->

	<resultMap id="forecastVO" type="com.cep.forecast.vo.ForecastVO">
		<result property="spKey"           column="SP_KEY"/>
		<result property="acKey"           column="AC_KEY"/>
		<result property="spBusiNm"        column="SP_BUSI_NM"/>
		<result property="pmKey"           column="PM_KEY"/>
		<result property="pmDetail"        column="PM_DETAIL"/>
		<result property="fcSjConfQt"      column="FC_SJ_CONF_QT"/>
		<result property="fcBuyAmount"     column="FC_SALES_AMOUNT"/>
		<result property="fcSalesAmount"   column="FC_BUY_AMOUNT"/>
		<result property="fcSalesProfit"   column="FC_SALES_PROFIT"/>
		<result property="fcSalesDt"       column="FC_SALES_DT"/>
		<result property="fcCollectDt"     column="FC_COLLECT_DT"/>
		<result property="fcBuyPayDt"      column="FC_BUY_PAY_DT"/>
		<result property="spState"         column="SP_STATE"/>
		<result property="salesAcKey"      column="SALES_AC_KEY"/>
		<result property="buyAcKey"        column="BUY_AC_KEY"/>
		<result property="remark"          column="REMARK"/>
		<result property="regDt"           column="REG_DT"/>
		<result property="regTm"           column="REG_TM" />
		<result property="regEmpKey"       column="REG_EMP_KEY" />
		<result property="modDt"           column="MOD_DT"/>
		<result property="modTm"           column="MOD_TM" />
		<result property="modEmpKey"       column="MOD_EMP_KEY" />
		
		<result property="mfAcNm"          column="MF_AC_NM" />
		<result property="pmDetailClassCd" column="PM_DETAIL_CLASS_CD" />
		<result property="pmNm"            column="PM_NM" />
		<result property="salesAcNm"       column="SALES_AC_NM" />
		<result property="buyAcNm"         column="BUY_AC_NM" />
	</resultMap>
	
	<!--
		Forecast 목록 조회 쿼리
	  -->
	<!-- 
	<select id="selectFocecastList" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultMap="forecastVO">				
	 -->
	 
	 <select id="selectFocecastList" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">	
		SELECT SM.SP_KEY              AS SP_KEY
		     , SM.AC_KEY              AS AC_KEY
		     , SM.SP_BUSI_NM          AS SP_BUSI_NM
		     , SM.PM_KEY              AS PM_KEY
		     , SM.PM_DETAIL           AS PM_DETAIL
		     , SM.FC_SJ_CONF_QT       AS FC_SJ_CONF_QT
		     , SM.FC_SALES_AMOUNT     AS FC_SALES_AMOUNT
		     , SM.FC_BUY_AMOUNT       AS FC_BUY_AMOUNT
		     , SM.FC_SALES_PROFIT     AS FC_SALES_PROFIT
		     , SM.FC_SALES_DT         AS FC_SALES_DT
		     , SM.FC_COLLECT_DT       AS FC_COLLECT_DT
		     , SM.FC_BUY_PAY_DT       AS FC_BUY_PAY_DT
		     , SM.SP_STATE            AS SP_STATE
		     , SM.SALES_AC_KEY        AS SALES_AC_KEY
		     , SM.BUY_AC_KEY          AS BUY_AC_KEY
		     , SM.REMARK              AS REMARK
		     , SM.REG_TM              AS REG_TM
		     , SM.REG_EMP_KEY         AS REG_EMP_KEY
		     , SM.MOD_DT              AS MOD_DT
		     , SM.MOD_TM              AS MOD_TM
		     , SM.MOD_EMP_KEY         AS MOD_EMP_KEY
			 , AC.AC_NM               AS MF_AC_NM
			 /*, PM.PM_NM_CD            AS PM_NM */
			 /*, PM.PM_DETAIL_CLASS_CD  AS PM_DETAIL_CLASS_CD */
			 , SAC.AC_NM              AS SALES_AC_NM
			 , BAC.AC_NM              AS BUY_AC_NM
			 , SM.SALES_CT_CLASS      AS SALES_CT_CLASS
		FROM SP_MAIN_TB          SM
			 JOIN CMM_ACCOUNT_TB AC    ON SM.AC_KEY = AC.AC_KEY 
			 /* JOIN PM_PRODUCT_MNG_TB PM ON SM.PM_KEY = PM.PM_KEY */
			 JOIN CMM_ACCOUNT_TB SAC   ON SM.SALES_AC_KEY = SAC.AC_KEY
			 JOIN CMM_ACCOUNT_TB BAC   ON SM.BUY_AC_KEY = BAC.AC_KEY
			 JOIN CMM_EMPLOYEE_TB EP   ON SM.REG_EMP_KEY = EP.EMP_KEY 
		WHERE 1=1	
		
		  <if test="spState != null and spState != ''" >
		  	 AND SM.SP_STATE = #{spState}
		  </if>
		  
		  <if test="pjFlag != null and pjFlag != ''" >
		  	  AND SM.SALES_CT_CLASS = #{pjFlag}
		  </if>
		  
		  <if test="searchFlag != null and searchFlag != ''" >
			
			<if test="searchFlag.equals('AC')" >
	  			AND AC.AC_NM LIKE CONCAT('%', #{searchValue}, '%')
	  		</if>
			  	
			<if test="searchFlag.equals('BN')" >
	  			AND SM.SP_BUSI_NM LIKE CONCAT('%', #{searchValue}, '%')
	  		</if>
	  		
	  		<if test="searchFlag.equals('SE')" >
	  			AND EP.EMP_NM LIKE CONCAT('%', #{searchValue}, '%')
	  		</if>
	  		
		  </if>
		  
		ORDER BY SM.REG_DT DESC, SM.REG_TM DESC		
		
	</select>
	
	<select id="makeSpKey" resultType="String">
		SELECT make_key('SP')
	</select>
	
	<insert id="insertBasic" parameterType="com.cep.forecast.vo.ForecastVO">
		INSERT INTO SP_MAIN_TB
		(
			  SP_KEY
			, AC_KEY
			, SALES_CT_CLASS
			, SP_BUSI_NM
			, PM_KEY
			, PM_DETAIL
			, FC_SJ_CONF_QT
			, SP_STATE
			, REG_DT
			, REG_TM
			, REG_EMP_KEY
		)
		VALUES
		(
			  #{spKey}
			, #{acKey}
			, #{salesCtClass}
			, #{spBusiNm}
			, #{pmKey}
			, #{pmDetail}
			, #{fcSjConfQt}
			, #{spState}
			, DATE_FORMAT(NOW(),'%Y%m%d')
			, DATE_FORMAT(NOW(),'%k%i%s')
			, #{regEmpKey}
		)

	</insert>
	
	<update id="updateBasic" parameterType="com.cep.forecast.vo.ForecastVO">
	
		UPDATE SP_MAIN_TB
		SET    AC_KEY         = #{acKey}
			 , SALES_CT_CLASS = #{salesCtClass}
			 , SP_BUSI_NM     = #{spBusiNm}
			 , PM_KEY         = #{pmKey}
			 , PM_DETAIL      = #{pmDetail}
			 , FC_SJ_CONF_QT  = #{fcSjConfQt}
			 , SP_STATE       = #{spState}
			 , MOD_DT         = DATE_FORMAT(NOW(),'%Y%m%d')
			 , MOD_TM         = DATE_FORMAT(NOW(),'%k%i%s') 
			 , MOD_EMP_KEY    = #{regEmpKey}
		WHERE  SP_KEY = #{spKey}

	</update>
	
	
	
	<select id="selectForecast" parameterType="com.cep.forecast.vo.ForecastVO" resultMap="forecastVO">				
		
		SELECT SM.SP_KEY              AS SP_KEY 
		     , SM.AC_KEY              AS AC_KEY
		     , SM.SP_BUSI_NM          AS SP_BUSI_NM
		     , SM.PM_KEY              AS PM_KEY
		     , SM.PM_DETAIL           AS PM_DETAIL
		     , SM.FC_SJ_CONF_QT       AS FC_SJ_CONF_QT
		     , SM.FC_SALES_AMOUNT     AS FC_SALES_AMOUNT
		     , SM.FC_BUY_AMOUNT       AS FC_BUY_AMOUNT
		     , SM.FC_SALES_PROFIT     AS FC_SALES_PROFIT
		     , SM.FC_SALES_DT         AS FC_SALES_DT
		     , SM.FC_COLLECT_DT       AS FC_COLLECT_DT
		     , SM.FC_BUY_PAY_DT       AS FC_BUY_PAY_DT
		     , SM.SP_STATE            AS SP_STATE
		     , SM.SALES_AC_KEY        AS SALES_AC_KEY
		     , SM.BUY_AC_KEY          AS BUY_AC_KEY
		     , SM.REMARK              AS REMARK
		     , SM.REG_TM              AS REG_TM
		     , SM.REG_EMP_KEY         AS REG_EMP_KEY
		     , EP.EMP_NM              AS EMP_NM
		     , SM.MOD_DT              AS MOD_DT
		     , SM.MOD_TM              AS MOD_TM
		     , SM.MOD_EMP_KEY         AS MOD_EMP_KEY
		     , AC.AC_NM               AS MF_AC_NM
			  , (SELECT AC_NM FROM CMM_ACCOUNT_TB WHERE AC_KEY = SM.SALES_AC_KEY) AS SALES_AC_NM
			  , (SELECT AC_NM FROM CMM_ACCOUNT_TB WHERE AC_KEY = SM.BUY_AC_KEY)   AS BUY_AC_NM
		FROM SP_MAIN_TB           SM
			 JOIN CMM_ACCOUNT_TB  AC ON SM.AC_KEY  = AC.AC_KEY
			 JOIN CMM_EMPLOYEE_TB EP ON EP.EMP_KEY = SM.REG_EMP_KEY  
		WHERE SM.SP_KEY = #{spKey}
		ORDER BY SM.REG_DT DESC, SM.REG_TM DESC		
				
	</select>
	
	
	<!-- 영업회의 관련 -->
	
	<select id="selectFocecastListSm" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT SM.SP_KEY              AS SP_KEY
		     , SM.AC_KEY              AS AC_KEY
		     , SM.SP_BUSI_NM          AS SP_BUSI_NM
		     , SM.PM_KEY              AS PM_KEY
		     , SM.PM_DETAIL           AS PM_DETAIL
		     , SM.FC_SJ_CONF_QT       AS FC_SJ_CONF_QT
		     , SM.FC_SALES_AMOUNT     AS FC_SALES_AMOUNT
		     , SM.FC_BUY_AMOUNT       AS FC_BUY_AMOUNT
		     , SM.FC_SALES_PROFIT     AS FC_SALES_PROFIT
		     , SM.FC_SALES_DT         AS FC_SALES_DT
		     , SM.FC_COLLECT_DT       AS FC_COLLECT_DT
		     , SM.FC_BUY_PAY_DT       AS FC_BUY_PAY_DT
		     , SM.SP_STATE            AS SP_STATE
		     , SM.SALES_AC_KEY        AS SALES_AC_KEY
		     , SM.BUY_AC_KEY          AS BUY_AC_KEY
		     , SM.REMARK              AS REMARK
		     , SM.REG_TM              AS REG_TM
		     , SM.REG_EMP_KEY         AS REG_EMP_KEY
		     , SM.MOD_DT              AS MOD_DT
		     , SM.MOD_TM              AS MOD_TM
		     , SM.MOD_EMP_KEY         AS MOD_EMP_KEY
			 , AC.AC_NM               AS MF_AC_NM
			 , PM.PM_NM_CD            AS PM_NM
			 , PM.PM_DETAIL_CLASS_CD  AS PM_DETAIL_CLASS_CD
			 , SAC.AC_NM              AS SALES_AC_NM
			 , BAC.AC_NM              AS BUY_AC_NM
		FROM   SP_MAIN_TB          SM
		JOIN   CMM_ACCOUNT_TB      AC  ON SM.AC_KEY       = AC.AC_KEY
		JOIN   PM_PRODUCT_MNG_TB   PM  ON SM.PM_KEY       = PM.PM_KEY
		JOIN   CMM_ACCOUNT_TB      SAC ON SM.SALES_AC_KEY = SAC.AC_KEY
		JOIN   CMM_ACCOUNT_TB      BAC ON SM.BUY_AC_KEY   = BAC.AC_KEY
		WHERE  1 = 1
		 
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND SM.REG_EMP_KEY = #{salesEmpKey}
		</if>
		
		ORDER BY SM.REG_DT DESC, SM.REG_TM DESC	
	</select>
	
	
	<select id="selectFocecastAmount" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT IFNULL(SUM(SM.FC_SALES_AMOUNT), 0)     AS FC_SALES_AMOUNT
		     , IFNULL(SUM(SM.FC_BUY_AMOUNT), 0)       AS FC_PURCHASE_AMOUNT
		     , IFNULL(SUM(SM.FC_SALES_PROFIT), 0)     AS FC_PROFIT_AMOUNT
		FROM   SP_MAIN_TB          SM
		WHERE  1 = 1
		 /* 기간 조회 조건이 등록일 기준으로 하는 건 맞지 않은 것 같음 확인필요 */
		  
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND SM.REG_EMP_KEY = #{salesEmpKey}
		</if>
		
	</select>
	
		
	<select id="selectBiddingList" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT PMT.PJ_STATUS_CD           AS PJ_STATUS_CD
		     , PMT.SP_KEY                 AS SP_KEY
		     , CCM.CD_NM                  AS PJ_STATUS_NM
		     , PMT.PJ_KEY                 AS PJ_KEY
		     , PMT.PJ_NM                  AS PJ_NM
		     , PMT.AC_KEY                 AS AC_KEY
		     , CAT.AC_NM                  AS AC_NM
		     , PBT.BD_LIMIT_DT            AS BD_LIMIT_DT
		     , PBT.BD_LIMIT_TM            AS BD_LIMIT_TM
		     , PBT.BD_PROPOSAL_YN         AS BD_PROPOSAL_YN
		     , PBT.BD_GB_YN               AS BD_GB_YN
		     , PBT.BD_GB_FINISH_YN        AS BD_GB_FINISH_YN
		     , PBT.BD_PROPOSAL_PRESENT_YN AS BD_PROPOSAL_PRESENT_YN
		     , PBT.BD_PROPOSAL_PRESENT_DT AS BD_PROPOSAL_PRESENT_DT 
		     , SMT.FC_SALES_AMOUNT        AS SALES_AMOUNT
		     , SMT.FC_BUY_AMOUNT          AS BUY_AMOUNT
		     , SMT.FC_SALES_PROFIT        AS SALES_PROFIT
		     , SMT.PM_KEY                 AS PM_KEY
		     , PPM.PM_NM_CD               AS PM_NM
		     , SMT.FC_SALES_DT            AS SALES_DT
		     , SMT.FC_COLLECT_DT          AS COLLECT_DT
		     , SMT.FC_BUY_PAY_DT          AS BUY_PAY_DT
		FROM        PJ_MAIN_TB         PMT
		JOIN        PJ_BIDDING_TB      PBT ON PMT.PJ_KEY       = PBT.PJ_KEY AND PBT.DELETE_YN = 'N'
		JOIN        CMM_CODE_MNG_TB    CCM ON PMT.PJ_STATUS_CD = CCM.CD_KEY
		JOIN        CMM_ACCOUNT_TB     CAT ON PMT.AC_KEY       = CAT.AC_KEY
		LEFT JOIN   SP_MAIN_TB         SMT ON PMT.SP_KEY       = SMT.SP_KEY 
		LEFT JOIN   PM_PRODUCT_MNG_TB  PPM ON SMT.PM_KEY       = PPM.PM_KEY
		WHERE  PMT.DELETE_YN = 'N'
		/* AND  PMT.PJ_STATUS_CD = 'PJST1000' */
		  AND  PMT.REG_DT BETWEEN #{searchFromDt} AND #{searchToDt} /* 기간 조회 조건이 등록일 기준으로 하는 건 맞지 않은 것 같음 확인필요 */
		
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND PMT.PJ_SALE_EMP_KEY = #{salesEmpKey}
		</if>
		
	</select>
	
	
	<select id="selectBiddingAmount" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT IFNULL(SUM(SMT.FC_SALES_AMOUNT), 0)         AS BD_SALES_AMOUNT
		     , IFNULL(SUM(SMT.FC_BUY_AMOUNT), 0)           AS BD_PURCHASE_AMOUNT
		     , IFNULL(SUM(SMT.FC_SALES_PROFIT), 0)         AS BD_PROFIT_AMOUNT
		FROM        PJ_MAIN_TB         PMT
		JOIN        PJ_BIDDING_TB      PBT ON PMT.PJ_KEY       = PBT.PJ_KEY AND PBT.DELETE_YN = 'N'
		LEFT JOIN   SP_MAIN_TB         SMT ON PMT.SP_KEY       = SMT.SP_KEY 
		LEFT JOIN   PM_PRODUCT_MNG_TB  PPM ON SMT.PM_KEY       = PPM.PM_KEY
		WHERE  PMT.DELETE_YN = 'N'
		  AND  PMT.PJ_STATUS_CD = 'PJST1000'
		  AND  PMT.REG_DT BETWEEN #{searchFromDt} AND #{searchToDt} /* 기간 조회 조건이 등록일 기준으로 하는 건 맞지 않은 것 같음 확인필요 */
		
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND PMT.PJ_SALE_EMP_KEY = #{salesEmpKey}
		</if>
			
	</select>
	
	
	
	
	
		
	<select id="selectProjectList" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT PMT.PJ_STATUS_CD           AS PJ_STATUS_CD
		     , PMT.SP_KEY                 AS SP_KEY
		     , CCM.CD_NM                  AS PJ_STATUS_NM
		     , PMT.PJ_KEY                 AS PJ_KEY
		     , PMT.PJ_NM                  AS PJ_NM
		     , PMT.AC_KEY                 AS AC_KEY
		     , CAT.AC_NM                  AS AC_NM
		     , PBT.BD_LIMIT_DT            AS BD_LIMIT_DT
		     , PBT.BD_LIMIT_TM            AS BD_LIMIT_TM
		     , PBT.BD_PROPOSAL_YN         AS BD_PROPOSAL_YN
		     , PBT.BD_GB_YN               AS BD_GB_YN
		     , PBT.BD_GB_FINISH_YN        AS BD_GB_FINISH_YN
		     , PBT.BD_PROPOSAL_PRESENT_YN AS BD_PROPOSAL_PRESENT_YN
		     , SMT.FC_SALES_AMOUNT        AS SALES_AMOUNT
		     , SMT.FC_BUY_AMOUNT          AS BUY_AMOUNT
		     , SMT.FC_SALES_PROFIT        AS SALES_PROFIT
		     , SMT.PM_KEY                 AS PM_KEY
		     , PPM.PM_NM_CD               AS PM_NM
		     , SMT.FC_SALES_DT            AS SALES_DT
		     , SMT.FC_COLLECT_DT          AS COLLECT_DT
		     , SMT.FC_BUY_PAY_DT          AS BUY_PAY_DT
		FROM        PJ_MAIN_TB         PMT
		JOIN        PJ_BIDDING_TB      PBT ON PMT.PJ_KEY       = PBT.PJ_KEY AND PBT.DELETE_YN = 'N'
		JOIN        CMM_CODE_MNG_TB    CCM ON PMT.PJ_STATUS_CD = CCM.CD_KEY
		JOIN        CMM_ACCOUNT_TB     CAT ON PMT.AC_KEY       = CAT.AC_KEY
		LEFT JOIN   SP_MAIN_TB         SMT ON PMT.SP_KEY       = SMT.SP_KEY 
		LEFT JOIN   PM_PRODUCT_MNG_TB  PPM ON SMT.PM_KEY       = PPM.PM_KEY
		WHERE  PMT.DELETE_YN = 'N'
		/* AND  PMT.PJ_STATUS_CD = 'PJST1000' */
		  AND  PMT.REG_DT BETWEEN #{searchFromDt} AND #{searchToDt} /* 기간 조회 조건이 등록일 기준으로 하는 건 맞지 않은 것 같음 확인필요 */
		
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND PMT.PJ_SALE_EMP_KEY = #{salesEmpKey}
		</if>
		
	</select>
	
	
	<select id="selectProjectAmount" parameterType="com.cep.forecast.vo.ForecastSearchVO" resultType="egovMap">
	
		SELECT IFNULL(SUM(SMT.FC_SALES_AMOUNT), 0)         AS BD_SALES_AMOUNT
		     , IFNULL(SUM(SMT.FC_BUY_AMOUNT), 0)           AS BD_PURCHASE_AMOUNT
		     , IFNULL(SUM(SMT.FC_SALES_PROFIT), 0)         AS BD_PROFIT_AMOUNT
		FROM        PJ_MAIN_TB         PMT
		JOIN        PJ_BIDDING_TB      PBT ON PMT.PJ_KEY       = PBT.PJ_KEY AND PBT.DELETE_YN = 'N'
		LEFT JOIN   SP_MAIN_TB         SMT ON PMT.SP_KEY       = SMT.SP_KEY 
		LEFT JOIN   PM_PRODUCT_MNG_TB  PPM ON SMT.PM_KEY       = PPM.PM_KEY
		WHERE  PMT.DELETE_YN = 'N'
		  AND  PMT.PJ_STATUS_CD = 'PJST1000'
		  AND  PMT.REG_DT BETWEEN #{searchFromDt} AND #{searchToDt} /* 기간 조회 조건이 등록일 기준으로 하는 건 맞지 않은 것 같음 확인필요 */
		
		<if test="salesEmpKey != null and salesEmpKey != ''">
			AND PMT.PJ_SALE_EMP_KEY = #{salesEmpKey}
		</if>
			
	</select>
	
	
	
</mapper>